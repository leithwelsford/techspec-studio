# Protocol Terminology Depth in Specification Generation

## Problem Statement

Technical specifications generated by TechSpec Studio lack protocol-level detail. The system correctly identifies reference points and interfaces but fails to include the specific protocol commands, message types, and procedures that make specifications implementable by engineers.

The problem manifests across all technical domains - wherever reference documents define precise terminology, the system substitutes generic descriptions instead of using the authoritative terms.

**Examples of the problem across domains:**

| Domain | What's Generated | What's Needed |
|--------|------------------|---------------|
| **Telecom (3GPP)** | "Request policy from PCRF via Gx" | "Send CCR-I (Credit-Control-Request-Initial) to PCRF over Gx" |
| **Telecom (3GPP)** | "Receive policy response" | "Receive CCA-I (Credit-Control-Answer-Initial) with PCC rules" |
| **Networking** | "Send route update to peer" | "Send BGP UPDATE message with NLRI" |
| **Networking** | "Establish TCP connection" | "TCP SYN → SYN-ACK → ACK three-way handshake" |
| **WiFi (IEEE 802.11)** | "Device connects to network" | "STA sends Association Request; AP responds with Association Response" |
| **SIP/VoIP** | "Initiate call" | "Send INVITE request; receive 100 Trying, 180 Ringing, 200 OK" |
| **REST/HTTP** | "Create resource" | "POST /resources returns 201 Created with Location header" |
| **Cloud/K8s** | "Deploy application" | "kubectl apply -f deployment.yaml; Pod transitions to Running" |
| **Automotive** | "Send sensor data" | "Transmit CAN frame ID 0x123 with 8-byte payload" |

This is a **domain-agnostic problem**: the system uses generic descriptions instead of the precise terminology defined in reference documents.

## Root Cause Analysis

### The Content Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│  INPUTS                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │ BRS Document    │  │ Reference Docs  │  │ Guiding Prompt  │     │
│  │ (requirements)  │  │ (standards,     │  │ (user context)  │     │
│  │                 │  │  RFCs, specs)   │  │                 │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
│           │                    │                    │               │
│           └────────────────────┼────────────────────┘               │
│                                ▼                                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              SPECIFICATION GENERATION                        │   │
│  │                                                              │   │
│  │  Reference docs ARE included in context ✓                   │   │
│  │  BUT no instruction to extract/use their terminology ✗      │   │
│  │                                                              │   │
│  └──────────────────────────┬───────────────────────────────────┘   │
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              GENERATED SPECIFICATION                         │   │
│  │                                                              │   │
│  │  Contains: "policy request via Gx interface"                │   │
│  │  Missing:  "CCR-I command over Gx"                          │   │
│  │                                                              │   │
│  └──────────────────────────┬───────────────────────────────────┘   │
│                             │                                       │
│                             │ section.content                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              DIAGRAM GENERATION                              │   │
│  │                                                              │   │
│  │  Diagrams faithfully represent spec content                 │   │
│  │  Shows "Policy Request" because that's what spec says       │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### The Gap

In `sectionPrompts.ts`, reference documents are included with this header:

```typescript
// Line 399
"The following excerpts from reference documents are relevant to this section:"
```

And there's generic guidance:

```typescript
// Line 323
"Ensure alignment with these standards where applicable. Use standard terminology and reference formats."
```

**What's missing:** Explicit instruction to extract and use the EXACT protocol vocabulary from references.

### Why Diagrams Were a Red Herring

Diagrams are generated FROM the specification content:

```typescript
// AIService.ts:1072-1076
const blockResult = await this.generateBlockDiagram(
  section.content,  // ← Specification text is the input
  section.sectionTitle,
  ...
);
```

If the specification says "CCR-I/CCA-I", the diagram will show "CCR-I/CCA-I".
If the specification says "policy request", the diagram will show "Policy Request".

**The diagrams are working correctly - they're just visualizing generic spec content.**

### Contributing Factor: Brevity Guidance

Commit `f7a2f44` added aggressive brevity guidance to diagram prompts:

```
"⚠️ CRITICAL: KEEP LABELS SHORT"
"Message labels: Maximum 30-40 characters"
```

While this was for diagrams only, it may have influenced overall system behavior and user expectations. However, the root cause is upstream in specification generation.

---

## Solution Design

### Principle

Reference documents should be treated as **authoritative terminology sources**, not just background context. When a 3GPP spec defines "CCR-I command", the generated specification MUST use "CCR-I", not "policy request".

### Scope

This fix applies to **all domains**, not just telecom:
- If an IETF RFC defines "BGP UPDATE message", use that term
- If an IEEE spec defines "Association Request frame", use that term
- If a cloud reference defines "kubectl apply", use that term

The fix is domain-agnostic: "use terminology from your references."

---

## Implementation Plan

### Phase 1: Add Terminology Extraction Instruction (HIGH PRIORITY)

**File:** `src/services/ai/prompts/sectionPrompts.ts`

**Location:** `buildReferenceContext()` function, after line 410

**Change:** Add explicit instruction after including reference excerpts

```typescript
export function buildReferenceContext(excerpts?: ExtractedExcerpt[]): string {
  if (!excerpts || excerpts.length === 0) return '';

  let context = `
## Reference Documents

The following excerpts from reference documents are relevant to this section:

`;

  for (const excerpt of excerpts) {
    context += `### From: ${excerpt.referenceTitle}
${excerpt.content}

---

`;
  }

  // NEW: Add terminology extraction instruction
  context += `
## IMPORTANT: Reference Terminology Requirements

The reference documents above define the **authoritative terminology** for this specification. You MUST:

1. **Extract and use exact protocol/command names** from references:
   - Telecom/Diameter: "CCR-I", "CCA-U", "RAR" (not "policy request", "charging update")
   - Networking/BGP: "UPDATE", "KEEPALIVE", "NOTIFICATION" (not "route change", "heartbeat")
   - WiFi/802.11: "Association Request", "Beacon", "Probe Response" (not "connect request", "broadcast")
   - SIP: "INVITE", "BYE", "REGISTER" (not "call request", "hangup", "login")
   - HTTP/REST: "GET", "POST 201 Created", "PUT" (not "fetch", "create", "update")

2. **Do NOT paraphrase protocol terminology** with generic descriptions:
   - WRONG: "send a policy request to the PCRF"
   - CORRECT: "send a CCR-I (Credit-Control-Request-Initial) to the PCRF"
   - WRONG: "route update message"
   - CORRECT: "BGP UPDATE message with NLRI and Path Attributes"
   - WRONG: "device connects to WiFi"
   - CORRECT: "STA transmits Association Request frame; AP responds with Association Response"

3. **Use abbreviated forms with full expansion on first use:**
   - First use: "Credit-Control-Request-Initial (CCR-I)"
   - Subsequent uses: "CCR-I"

4. **Include procedure/command sequences** where references define them:
   - If reference defines "session establishment uses CCR-I/CCA-I exchange", include that detail
   - If reference defines "state machine transitions", include those states and triggers

The goal is an **implementable specification** where engineers can trace requirements directly to protocol commands.
`;

  return context;
}
```

### Phase 2: Enhance Domain Expertise Builder

**File:** `src/services/ai/prompts/sectionPrompts.ts`

**Location:** `buildDomainExpertise()` function

**Change:** Add terminology authority guidance

```typescript
export function buildDomainExpertise(domainConfig?: DomainConfig): string {
  if (!domainConfig) return '';

  const { domain, industry, standards, terminology } = domainConfig;

  let expertise = `You are an expert technical specification writer. Adapt your writing style, terminology,
and depth of detail to match the ${domain || 'technical'} domain${industry ? ` in the ${industry} industry` : ''}.

`;

  if (standards && standards.length > 0) {
    expertise += `**Reference Standards:** ${standards.join(', ')}\n\n`;
    expertise += `Ensure alignment with these standards where applicable. Use standard terminology and reference formats.\n\n`;
  }

  if (terminology && Object.keys(terminology).length > 0) {
    expertise += `**Key Terminology:**\n`;
    for (const [term, definition] of Object.entries(terminology)) {
      expertise += `- **${term}**: ${definition}\n`;
    }
    expertise += '\n';
  }

  // NEW: Add terminology authority instruction
  expertise += `
**Terminology Precision:**

When reference documents are provided, they define the **authoritative vocabulary** for this specification:

- **Protocol commands:** Use exact command names (CCR-I, UPDATE, INVITE), not generic verbs (request, send, notify)
- **Message types:** Use defined message names (Credit-Control-Answer, 200 OK), not descriptions (success response)
- **Procedures:** Use procedure names from standards (EPS Bearer Modification, TCP Three-Way Handshake)
- **Interfaces:** Use exact interface designations (Gx, S1-U, eth0), with protocol details where defined

Generic paraphrasing reduces specification precision and implementability. When in doubt, prefer the terminology found in reference documents.
`;

  return expertise;
}
```

### Phase 3: Update Document Generation Prompts

**File:** `src/services/ai/prompts/documentPrompts.ts`

**Location:** Around line 100-105

**Current:**
```typescript
3. Include detailed technical content with:
   - Definitions and terminology
   - Technical requirements using normative language
   - Protocol flows and procedures where applicable
```

**Change to:**
```typescript
3. Include detailed technical content with:
   - Definitions and terminology (use EXACT terms from reference documents)
   - Technical requirements using normative language
   - Protocol flows and procedures where applicable, using specific command/message names
     from references (e.g., "CCR-I/CCA-I exchange" not "policy request/response")
   - State machines and transitions using terminology from standards
```

### Phase 4: Update Section Generation Prompts

**File:** `src/services/ai/prompts/sectionPrompts.ts`

**Location:** `buildArchitectureSectionPrompt()` function, around line 848

**Current:**
```typescript
- Interfaces and integration points
```

**Change to:**
```typescript
- Interfaces and integration points, with specific protocol commands/messages used on each interface
  (e.g., "Gx interface: CCR-I/CCR-U/CCR-T commands", not just "Gx interface: policy control")
```

**Location:** `buildProceduresSectionPrompt()` function, around line 900

**Current:**
```typescript
Document operational procedures and workflows.
- Step-by-step procedures
```

**Change to:**
```typescript
Document operational procedures and workflows.
- Step-by-step procedures with exact protocol command sequences from reference documents
- Include specific message names, not generic descriptions (e.g., "UE sends Attach Request" not "UE requests attachment")
```

### Phase 5: Template-Specific Terminology (Optional Enhancement)

**File:** Template definitions in `src/data/templates/`

**Change:** Add `terminologyGuidance` field to templates for domain-specific hints

```typescript
// Example for 3GPP template
export const template3GPP: SpecificationTemplate = {
  id: '3gpp',
  name: '3GPP Technical Specification',
  // ... existing fields ...
  terminologyGuidance: `
**Diameter Interfaces:** Gx: CCR-I/CCR-U/CCR-T, CCA | Gy: CCR credit-control | Rx: AAR/AAA, STR/STA
**Procedures:** "EPS Bearer Establishment", "PDN Connection", "UE Attach"
**Sequences:** CCR-I → CCA-I → [traffic] → CCR-U → CCA-U → CCR-T → CCA-T
`
};

// Example for IEEE 802.11 (WiFi) template
export const templateIEEE80211: SpecificationTemplate = {
  id: 'ieee-80211',
  name: 'IEEE 802.11 Specification',
  terminologyGuidance: `
**Management Frames:** Beacon, Probe Request/Response, Association Request/Response, Authentication
**Control Frames:** RTS, CTS, ACK, Block ACK
**Procedures:** "Active Scanning", "Passive Scanning", "Open System Authentication", "4-Way Handshake"
`
};

// Example for IETF/Networking template
export const templateIETF: SpecificationTemplate = {
  id: 'ietf',
  name: 'IETF RFC-Style Specification',
  terminologyGuidance: `
**BGP:** UPDATE, KEEPALIVE, NOTIFICATION, OPEN messages
**TCP:** SYN, SYN-ACK, ACK, FIN, RST | Three-way handshake
**HTTP:** GET, POST, PUT, DELETE | Status codes: 200 OK, 201 Created, 404 Not Found
**DNS:** Query, Response | Record types: A, AAAA, CNAME, MX
`
};

// Example for Generic API template
export const templateAPI: SpecificationTemplate = {
  id: 'api',
  name: 'API Specification',
  terminologyGuidance: `
**REST:** Use HTTP verbs precisely (GET=read, POST=create, PUT=replace, PATCH=update, DELETE=remove)
**Responses:** Include status codes (201 Created, 400 Bad Request, 401 Unauthorized, 404 Not Found)
**Authentication:** "Bearer token", "API key", "OAuth 2.0 authorization code flow"
`
};
```

Then inject this guidance in `buildFlexibleSectionPrompt()` when a template is active.

---

## Files to Modify

| File | Change | Priority |
|------|--------|----------|
| `src/services/ai/prompts/sectionPrompts.ts` | Add terminology extraction instruction in `buildReferenceContext()` | HIGH |
| `src/services/ai/prompts/sectionPrompts.ts` | Enhance `buildDomainExpertise()` with terminology authority | HIGH |
| `src/services/ai/prompts/documentPrompts.ts` | Update "detailed technical content" guidance (~line 100) | MEDIUM |
| `src/services/ai/prompts/sectionPrompts.ts` | Update `buildArchitectureSectionPrompt()` | MEDIUM |
| `src/services/ai/prompts/sectionPrompts.ts` | Update `buildProceduresSectionPrompt()` | MEDIUM |
| `src/data/templates/*.ts` | Add `terminologyGuidance` field (optional) | LOW |

---

## Testing Strategy

### Test Case 1: 3GPP Telecom (PCC/Diameter)

**Input:**
- BRS mentioning "policy control", "online charging", "PCRF integration"
- Reference: 3GPP TS 29.212 (Gx interface) excerpt mentioning CCR/CCA commands

**Expected Output:**
- Specification mentions "CCR-I", "CCA-I", "CCR-U", "CCA-U" explicitly
- Diagrams show these command names, not "Policy Request/Response"

### Test Case 2: WiFi/IEEE 802.11

**Input:**
- BRS mentioning "WiFi access", "client association", "AP handoff"
- Reference: IEEE 802.11 excerpt mentioning Association Request/Response frames

**Expected Output:**
- Specification mentions "Association Request frame", "Beacon", "Probe Response"
- Diagrams show "Association Req/Resp", not "connect to network"

### Test Case 3: Networking (BGP/Routing)

**Input:**
- BRS mentioning "routing protocol", "BGP peering", "route distribution"
- Reference: RFC 4271 excerpt mentioning UPDATE, KEEPALIVE messages

**Expected Output:**
- Specification mentions "BGP UPDATE message with NLRI", "KEEPALIVE"
- Diagrams show "UPDATE", "NOTIFICATION", not "route change"

### Test Case 4: REST API Specification

**Input:**
- BRS mentioning "REST API", "CRUD operations", "authentication"
- Reference: OpenAPI/Swagger documentation excerpt

**Expected Output:**
- Specification mentions "POST /resources returns 201 Created"
- Diagrams show "GET /users → 200 OK", not "fetch users"

### Test Case 5: SIP/VoIP

**Input:**
- BRS mentioning "voice calls", "session initiation", "call transfer"
- Reference: RFC 3261 (SIP) excerpt mentioning INVITE, BYE, REGISTER

**Expected Output:**
- Specification mentions "INVITE request", "200 OK response", "BYE"
- Diagrams show "INVITE → 100 Trying → 180 Ringing → 200 OK → ACK"

### Test Case 6: Generic (No References)

**Input:**
- BRS with generic requirements, no specific protocols
- No reference documents provided

**Expected Output:**
- System continues to work with descriptive terminology (no regression)
- No errors from missing reference context
- Terminology is as specific as the BRS allows

---

## Success Criteria

1. **Specifications include exact protocol terminology** from reference documents
2. **Diagrams automatically reflect this terminology** (no separate diagram fix needed)
3. **Works for any domain** - telecom, networking, cloud, automotive, etc.
4. **No regression** - specs without references still generate correctly
5. **Maintains readability** - first use expands acronyms, subsequent uses abbreviated

---

## Estimated Effort

| Phase | Effort | Impact |
|-------|--------|--------|
| Phase 1: Terminology instruction | 1-2 hours | HIGH |
| Phase 2: Domain expertise enhancement | 1-2 hours | MEDIUM |
| Phase 3: Document prompts update | 1 hour | MEDIUM |
| Phase 4: Section prompts update | 1-2 hours | MEDIUM |
| Phase 5: Template terminology (optional) | 2-3 hours | LOW |
| Testing | 2-3 hours | - |

**Total: 8-13 hours**

Phases 1-2 alone should solve ~80% of the problem.

---

## Related Context

### Previous Work
- Commit `f7a2f44`: Added brevity guidance to diagrams (may need review)
- Commit `97ed544`: Auto-assign figure numbers
- Recent bug fix: ER diagrams not being stored (fixed in `autoNumberFigures()`)

### Key Files for Context
- `src/services/ai/contextManager.ts` - How reference excerpts are extracted
- `src/services/ai/AIService.ts` - Diagram generation receives `section.content`
- `src/services/ai/prompts/diagramPrompts.ts` - Diagram-specific prompts (NOT the root cause)

### User Guiding Prompt
Users can already add terminology preferences via the guiding prompt. After this fix, the guiding prompt can reinforce but shouldn't be required for basic protocol terminology usage.
