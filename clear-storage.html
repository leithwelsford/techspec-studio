<!DOCTYPE html>
<html>
<head>
    <title>Clear TechSpec Studio Storage</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #60a5fa; }
        .info-box {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .warning {
            background: #4a2a2a;
            border-color: #ff6b6b;
        }
        button {
            background: #60a5fa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        button:hover { background: #3b82f6; }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover { background: #dc2626; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>TechSpec Studio Storage Manager</h1>
    
    <div class="info-box">
        <h2>Current Storage Status</h2>
        <div id="storage-info">Calculating...</div>
    </div>

    <div class="info-box warning">
        <h2>⚠️ Storage Quota Exceeded</h2>
        <p>Your browser's localStorage has exceeded its quota (typically 5-10MB).</p>
        <p>This is likely due to:</p>
        <ul>
            <li>Large technical specification document (100k+ characters)</li>
            <li>Multiple version snapshots accumulating over time</li>
            <li>AI-generated content and diagrams</li>
        </ul>
    </div>

    <div class="info-box">
        <h2>Options to Free Up Space</h2>
        
        <h3>Option 1: Clear Old Version Snapshots (Recommended)</h3>
        <p>Keeps your document but removes old version history.</p>
        <button onclick="clearSnapshots()">Clear Version History</button>
        
        <h3>Option 2: Clear Pending Approvals</h3>
        <p>Removes all pending AI approvals (you can regenerate them).</p>
        <button onclick="clearApprovals()">Clear Pending Approvals</button>
        
        <h3>Option 3: Export & Clear All Data</h3>
        <p class="error">⚠️ This will clear everything. Export first!</p>
        <button onclick="exportData()">1. Export Data (JSON)</button>
        <button class="danger" onclick="clearAll()">2. Clear All Storage</button>
    </div>

    <div class="info-box">
        <h2>Action Log</h2>
        <div id="log"></div>
    </div>

    <script>
        function log(message, isError = false) {
            const logDiv = document.getElementById('log');
            const p = document.createElement('p');
            p.className = isError ? 'error' : 'success';
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(p);
        }

        function updateStorageInfo() {
            try {
                const stored = localStorage.getItem('tech-spec-project');
                if (stored) {
                    const data = JSON.parse(stored);
                    const size = new Blob([stored]).size;
                    const sizeMB = (size / 1024 / 1024).toFixed(2);
                    
                    const snapshots = data.state?.project?.versionHistory?.snapshots || [];
                    const approvals = data.state?.pendingApprovals || [];
                    const specLength = data.state?.project?.specification?.markdown?.length || 0;
                    
                    document.getElementById('storage-info').innerHTML = `
                        <pre>Total Size: ${sizeMB} MB (${size.toLocaleString()} bytes)
Document: ${(specLength / 1024).toFixed(1)} KB
Version Snapshots: ${snapshots.length}
Pending Approvals: ${approvals.length}
Estimated Max: 5-10 MB (browser dependent)</pre>
                    `;
                } else {
                    document.getElementById('storage-info').textContent = 'No data found.';
                }
            } catch (e) {
                document.getElementById('storage-info').innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
        }

        function clearSnapshots() {
            if (!confirm('Clear all version snapshots? Your document will be preserved.')) return;
            
            try {
                const stored = localStorage.getItem('tech-spec-project');
                const data = JSON.parse(stored);
                
                const snapshotCount = data.state?.project?.versionHistory?.snapshots?.length || 0;
                
                if (data.state?.project?.versionHistory) {
                    data.state.project.versionHistory.snapshots = [];
                    data.state.project.versionHistory.currentSnapshotId = null;
                }
                
                localStorage.setItem('tech-spec-project', JSON.stringify(data));
                log(`✅ Cleared ${snapshotCount} version snapshots`);
                updateStorageInfo();
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (e) {
                log(`❌ Error: ${e.message}`, true);
            }
        }

        function clearApprovals() {
            if (!confirm('Clear all pending approvals? You can regenerate them later.')) return;
            
            try {
                const stored = localStorage.getItem('tech-spec-project');
                const data = JSON.parse(stored);
                
                const approvalCount = data.state?.pendingApprovals?.length || 0;
                
                if (data.state) {
                    data.state.pendingApprovals = [];
                }
                
                localStorage.setItem('tech-spec-project', JSON.stringify(data));
                log(`✅ Cleared ${approvalCount} pending approvals`);
                updateStorageInfo();
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (e) {
                log(`❌ Error: ${e.message}`, true);
            }
        }

        function exportData() {
            try {
                const stored = localStorage.getItem('tech-spec-project');
                const blob = new Blob([stored], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `techspec-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                log('✅ Data exported successfully');
            } catch (e) {
                log(`❌ Export failed: ${e.message}`, true);
            }
        }

        function clearAll() {
            if (!confirm('⚠️ CLEAR ALL DATA? This cannot be undone!\n\nMake sure you exported first!')) return;
            if (!confirm('Are you REALLY sure? All documents, diagrams, and settings will be lost!')) return;
            
            try {
                localStorage.removeItem('tech-spec-project');
                log('✅ All storage cleared');
                updateStorageInfo();
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (e) {
                log(`❌ Error: ${e.message}`, true);
            }
        }

        // Initial load
        updateStorageInfo();
    </script>
</body>
</html>
